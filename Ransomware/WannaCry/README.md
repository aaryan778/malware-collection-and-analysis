[![MIT license](https://img.shields.io/github/license/othneildrew/Best-README-Template.svg?style=for-the-badge)](https://opensource.org/licenses/MIT)
[![linkedin](https://img.shields.io/badge/-LinkedIn-black.svg?style=for-the-badge&logo=linkedin&colorB=555)](https://www.linkedin.com/in/aaryanmandanapu/)
# WannaCry
## A Technical Analysis of WannaCry Ransomware

![](https://media.istockphoto.com/vectors/wannacry-virus-binary-code-ransomware-virus-computer-concept-vector-vector-id686724028?k=6&m=686724028&s=612x612&w=0&h=-v-kDvJalqGUSJLlH0MDdpz7VnUhDspIbZn1leMNwY4=)

## Table of Contents

- [Summary](#summary)
- [Who was behind the attack?](#who-was-behind-the-attack)
- [What caused the attack?](#what-caused-the-attack)
- [Details of the Ransomware Worm](#details-of-the-ransomware-worm)
    - [Vulnerable Machines](#vulnerable-machines)
    - [Infections](#infections)
    - [Informative Tweets](#informative-tweets)
    - [Cryptography Details](#cryptography-details)
    - [Command and Control Centers](#command-and-control-centers)
    - [Languages](#languages)
    - [File Types](#file-types)
- [Dissecting Wannacry Ransomware](#dissecting-wannacry-ransomware)
- [The sinkhole that saved the Internet](#the-sinkhole-that-saved-the-internet)
- [Official Statements Issued](#official-statements-issued)
- [Adding Up the Cost of WannaCry](#adding-up-the-cost-of-wannacry)
- [Vulnerability discosure](#vulnerability-disclosure)

## Summary

  WannaCry is a ransomware worm that spread rapidly through across a number of computer networks in May of 2017. 
  After infecting a Windows computers, it encrypts files on the PC's hard drive, making them impossible for users to access, then demands a ransom payment in bitcoin in order to decrypt them.

  A number of factors made the initial spread of WannaCry particularly noteworthy: it struck a number of important and high-profile systems, including many in Britain's National Health Service; it exploited a Windows vulnerability that was suspected to have been first discovered by the United States National Security Agency; and it was tentatively linked by Symantec and other security researchers to the Lazarus Group, a cybercrime organization that may be connected to the North Korean government.<br> <br>
 
  
  ~~~  
      
     Date            --->  12 ùìúùì™ùîÇ 2017 ‚Äì 15 ùìúùì™ùîÇ 2017 (initial outbreak)
     Duration        --->  4 Days
     Location        --->  Worldwide
     Type            --->  Cyberattack
     Theme           --->  Ransomware encrypting files with $300 ‚Äì $600 USD demand (via bitcoin)
     Cause           --->  WannaCry Worm
     Outcome         --->  200,000 victims 300,000+ computers infected
     Arrests         --->  None
     Suspects        --->  Lazarus Group
     Point Of Origin --->  Pyongyang, North Korea
  ~~~
  
 <br> 

 
## Who was behind the attack?

   The attack used Eternalblue, the name given to the software vulnerability in Microsoft‚Äôs Windows operating system, and works by exploiting the Microsoft Server Message Block 1.0. The Server Message Block (SMB) is a network file sharing protocol and ‚Äòallows applications on a computer to read and write to files and to request services‚Äô that are on the same network.

   Ironically, it was allegedly developed as a cyber-attack exploit by the US National Security Agency.  Although they were reported to have known of the tool‚Äôs vulnerabilities, the NSA didn‚Äôt bring it to Microsoft‚Äôs attention until the hacker group called Shadow Brokers leaked EternalBlue to an obscure website.

   Further analysis of the attack by companies such as Symantec revealed links to the Lazarus group who in turn have been linked to North Korea although the attack does not bear the hallmarks of a nation-state campaign.
   
## What caused the attack?
   
   On Tuesday, March 14, 2017, Microsoft issued a security bulletin, which detailed the flaw and announced that patches had been released for all Windows versions that were currently supported at that time. The Department of Health was warned about the risks of cyber-attacks on the NHS a year before WannaCry and although it had work under way it did not formally respond with a written report until July 2017.

   At the time of the attacks, the NHS was criticized for using outdated IT systems, including Windows XP, a 17-year-old operating system that could be vulnerable to cyber-attacks. In an unusual move, Microsoft released a WannaCry patch for unsupported systems such as Windows XP which Microsoft stopped supporting in 2014.

   The NHS had not rehearsed for a national cyber-attack it was not immediately clear who should lead the response. There were problems with communications because emails were either infected or shut down to prevent the ransomware spreading. It‚Äôs clear that the disaster recovery plan at the time had not accounted for a cyber-attack of this scale nor were there communication contingencies if the main network was inaccessible. There was no clear relationship between trusts infected by WannaCry and the quality of their leadership, as rated by the Care Quality Commission.

## Details of the Ransomware Worm
  
   
* **Virus Name**: WannaCrypt, WannaCry, WanaCrypt0r, WCrypt, WCRY
* **Vector**: All Windows versions before Windows 10 are vulnerable if not patched for MS-17-010. It uses EternalBlue MS17-010 to propagate.
* **Ransom**: Between $300 to $600. There is code to 'rm' (delete) files in the virus. Seems to reset if the virus crashes.
* **Backdooring**: The worm loops through every RDP session on a system to run the ransomware as that user. It also installs the DOUBLEPULSAR backdoor. It corrupts shadow volumes to make recovery harder. (source: malwarebytes)
* **Kill switch**: If the website `www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com` is up the virus exits instead of infecting the host. (source: malwarebytes). This domain has been sinkholed, stopping the spread of the worm. Will not work if proxied ([source](https://blog.didierstevens.com/2017/05/13/quickpost-wcry-killswitch-check-is-not-proxy-aware/)).

*Update*: A minor variant of the virus has been found, it looks to have had the killswitch hexedited out. Not done by recompile so probably not done by the original malware author. On the other hand that is the only change: the encryption keys are the same, the bitcoin addresses are the same. On the other hand it is corrupt so the ransomware aspect of it doesn't work - it only propagates.

SECURITY BULLETIN AND UPDATES HERE: https://technet.microsoft.com/en-us/library/security/ms17-010.aspx

Microsoft first patch for XP since 2014: https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/

Killswitch source: https://blog.malwarebytes.com/threat-analysis/2017/05/the-worm-that-spreads-wanacrypt0r/ https://www.malwaretech.com/2017/05/how-to-accidentally-stop-a-global-cyber-attacks.html

Exploit details: https://zerosum0x0.blogspot.com/2017/04/doublepulsar-initial-smb-backdoor-ring.html

# Vulnerable Machines

To be infected requires the SMB port (445) to be open, or the machine already infected with DOUBLEPULSAR (and killswitch not registered or somehow blocked, or the network accessing it through a proxy).

The MS17-010 patch fixes the vulnerability.

* Windows XP: Doesn't spread. If run manually, can encrypt files.
* Windows 7,8,2008: can spread unpatched, can encrypt files.
* Windows 10: Doesn't spread. Even though Windows 10 [does have the faulty SMB driver](http://www.infoworld.com/article/3196825/microsoft-windows/how-to-make-sure-your-windows-pc-wont-get-hit-by-ransomware-like-wannacrypt.html).
* Linux: Doesn't spread. If run manually with wine, can encrypt files.

# Infections

* NHS (uk) turning away patients, unable to perform x-rays. ([list of affected hospitals](http://news.sky.com/story/nhs-cyberattack-full-list-of-organisations-affected-so-far-10874493))
* Nissan (uk) http://www.chroniclelive.co.uk/news/north-east-news/cyber-attack-nhs-latest-news-13029913
* Telefonica (spain) (https://twitter.com/SkyNews/status/863044193727389696)
* power firm Iberdrola and Gas Natural ([spain](http://www.bbc.co.uk/news/technology-39901382))
* FedEx (us) (https://twitter.com/jeancreed1/status/863089728253505539)
* University of Waterloo ([ontario canada](https://twitter.com/amtinits))
* Russia interior ministry & Megafon (russia) https://twitter.com/dabazdyrev/status/863034199460261890/photo/1
* VTB (russian bank) https://twitter.com/vassgatov/status/863175506790952962
* Russian Railroads (RZD) https://twitter.com/vassgatov/status/863175723846176768 
* [Portugal Telecom](http://imgur.com/a/rR3b9)
* –°–±–µ—Ä–±–∞–Ω–∫ - Sberbank Russia ([russia](https://twitter.com/discojournalist/status/863162464304865280))
* Shaheen Airlines (pakistan, [claimed on twitter](https://twitter.com/Beyhooda/status/863161471987068930))
* Train station in frankfurt ([germany](https://twitter.com/Nick_Lange_/status/863132237822394369))
* Neustadt station ([germany](https://twitter.com/MedecineLibre/status/863139139138531328))
* the entire network of German Rail seems to be affected ([@farbenstau](https://twitter.com/farbenstau/status/863166384834064384))
* in China secondary schools and universities had been affected ([source](http://english.alarabiya.net/en/News/world/2017/05/13/Russia-s-interior-ministry-says-computers-hit-by-virus-attack-.html))
* A Library in Oman ([@99arwan1](https://twitter.com/99arwan1/status/863325279653171200))
* China Yanshui County Public Security Bureau (https://twitter.com/95cnsec/status/863292545278685184)
* Renault (France) (http://www.lepoint.fr/societe/renault-touche-par-la-vague-de-cyberattaques-internationales-13-05-2017-2127044_23.php) (http://www.lefigaro.fr/flash-eco/2017/05/13/97002-20170513FILWWW00031-renault-touche-par-la-vague-de-cyberattaques-internationales.php)
* Schools/Education (France) https://twitter.com/Damien_Bancal/status/863305670568837120 
* University of Milano-Bicocca ([italy](http://milano.repubblica.it/cronaca/2017/05/12/news/milano_virus_ransomware_universita_bicocca-165302056/?ref=drnweb.repubblica.scroll-3)) 
* A mall in singapore https://twitter.com/nkl0x55/status/863340271391580161
* ATMs in china https://twitter.com/95cnsec/status/863382193615159296
* norwegian soccer team ticket sales https://www.nrk.no/telemark/eliteserieklubber-rammet-av-internasjonalt-dataangrep-1.13515245
* STC telecom ([saudia arabia](https://twitter.com/iPhone_Supp/status/863735059819442177), [more](https://twitter.com/mhooh300/status/863734116142985216), [more](https://twitter.com/bynfck/status/863734011188854784))
* [All ATMs in india closed](http://newsable.asianetnews.tv/india/over-2-lakh-atms-in-the-country-to-remain-closed-to-deal-with-cyberattack)
* US radiology equipment https://twitter.com/Forbes/status/864850749225934852
* More at https://en.wikipedia.org/wiki/WannaCry_cyber_attack#List_of_affected_organizations they seem to be cataloguing the infections faster/better.

# Informative Tweets

* Sample released by ens (thank you ens!): https://twitter.com/the_ens/status/863055007842750465
* Onion C&Cs extracted: https://twitter.com/the_ens/status/863069021398339584
* EternalBlue confirmed: https://twitter.com/kafeine/status/863049739583016960
* Shell commands: https://twitter.com/laurilove/status/863065599919915010
* Maps/stats: https://twitter.com/laurilove/status/863066699888824322
* Core DLL: https://twitter.com/laurilove/status/863072240123949059
* Hybrid-analysis: https://twitter.com/PayloadSecurity/status/863024514933956608
* Impact assessment: https://twitter.com/CTIN_Global/status/863095852113571840
* Uses DoublePulsar: https://twitter.com/laurilove/status/863107992425779202 
* Your machine is attacking others: https://twitter.com/hackerfantastic/status/863105127196106757
* Tor hidden service C&C: https://twitter.com/hackerfantastic/status/863105031167504385
* FedEx infected via Telefonica? https://twitter.com/jeancreed1/status/863089728253505539
* HOW TO AVOID INFECTION: https://twitter.com/hackerfantastic/status/863070063536091137
* More of this to come: https://twitter.com/hackerfantastic/status/863069142273929217
* C&C hosts: https://twitter.com/hackerfantastic/status/863115568181850113
* Crypted files *will* be deleted after countdown: https://twitter.com/laurilove/status/863116900829724672
* Claim of attrib [take with salt]: https://twitter.com/0xSpamTech/status/863058605473509378
* Track the bitcoins: https://twitter.com/bl4sty/status/863143484919828481
* keys in pem format: https://twitter.com/e55db081d05f58a/status/863109716456747008
* neel points out a similarity with another virus https://twitter.com/neelmehta/status/864164081116225536
* shadowbrokers talk about responsible disclosure https://steemit.com/shadowbrokers/@theshadowbrokers/oh-lordy-comey-wanna-cry-edition
* another factsheet https://www.secureworks.com/research/wcry-ransomware-analysis

# Cryptography details

* Each infection generates a new RSA-2048 keypair.
* The public key is exported as blob and saved to 00000000.pky
* The private key is encrypted with the ransomware public key and saved as 00000000.eky
* Each file is encrypted using AES-128-CBC, with a unique AES key per file.
* Each AES key is generated CryptGenRandom.
* The AES key is encrypted using the infection specific RSA keypair.

The RSA public key used to encrypt the infection specific RSA private key is embedded inside the DLL and owned by the ransomware authors.

* https://haxx.in/key1.bin (the ransomware pubkey, used to encrypt the users private key)
* https://haxx.in/key2.bin (the dll decryption privkey)
the CryptImportKey() rsa key blob dumped from the DLL by blasty.

https://pastebin.com/aaW2Rfb6 even more in depth RE information by cyg_x1!!


# Bitcoin ransom addresses

3 addresses hard coded into the malware.# Vulnerable Machines

* https://blockchain.info/address/13AM4VW2dhxYgXeQepoHkHSQuy6NgaEb94
* https://blockchain.info/address/12t9YDPgwueZ9NyMgw519p7AA8isjr6SMw
* https://blockchain.info/address/115p7UMMngoj1pMvkpHijcRdfJNXj6LrLn



# Command and Control Centers

* `gx7ekbenv2riucmf.onion`
* `57g7spgrzlojinas.onion`
* `xxlvbrloxvriy2c5.onion`
* `76jdd2ir2embyv47.onion`
* `cwwnhwhlz52maqm7.onion`



# Languages

All language ransom messages available here: https://transfer.sh/y6qco/WANNACRYDECRYPTOR-Ransomware-Messages-all-langs.zip

m_bulgarian, m_chinese (simplified), m_chinese (traditional), m_croatian, m_czech, m_danish, m_dutch, m_english, m_filipino, m_finnish, m_french, m_german, m_greek, m_indonesian, m_italian, m_japanese, m_korean, m_latvian, m_norwegian, m_polish, m_portuguese, m_romanian, m_russian, m_slovak, m_spanish, m_swedish, m_turkish, m_vietnamese

# File Types

There are a number of files and folders wannacrypt will avoid. Some because it's entirely pointless and others because it might destabilize the system. During scans, it will search the path for the following strings and skip over if present:

*   "Content.IE5"
*   "Temporary Internet Files"
*   " This folder protects against ransomware. Modifying it will reduce protection"
*   "\Local Settings\Temp"
*   "\AppData\Local\Temp"
*   "\Program Files (x86)"
*   "\Program Files"
*   "\WINDOWS"
*   "\ProgramData"
*   "\Intel"
*   "$\"

The filetypes it looks for to encrypt are:

.doc, .docx, .xls, .xlsx, .ppt, .pptx, .pst, .ost, .msg, .eml, .vsd, .vsdx, .txt, .csv, .rtf, .123, .wks, .wk1, .pdf, .dwg, .onetoc2, .snt, .jpeg, .jpg, .docb, .docm, .dot, .dotm, .dotx, .xlsm, .xlsb, .xlw, .xlt, .xlm, .xlc, .xltx, .xltm, .pptm, .pot, .pps, .ppsm, .ppsx, .ppam, .potx, .potm, .edb, .hwp, .602, .sxi, .sti, .sldx, .sldm, .sldm, .vdi, .vmdk, .vmx, .gpg, .aes, .ARC, .PAQ, .bz2, .tbk, .bak, .tar, .tgz, .gz, .7z, .rar, .zip, .backup, .iso, .vcd, .bmp, .png, .gif, .raw, .cgm, .tif, .tiff, .nef, .psd, .ai, .svg, .djvu, .m4u, .m3u, .mid, .wma, .flv, .3g2, .mkv, .3gp, .mp4, .mov, .avi, .asf, .mpeg, .vob, .mpg, .wmv, .fla, .swf, .wav, .mp3, .sh, .class, .jar, .java, .rb, .asp, .php, .jsp, .brd, .sch, .dch, .dip, .pl, .vb, .vbs, .ps1, .bat, .cmd, .js, .asm, .h, .pas, .cpp, .c, .cs, .suo, .sln, .ldf, .mdf, .ibd, .myi, .myd, .frm, .odb, .dbf, .db, .mdb, .accdb, .sql, .sqlitedb, .sqlite3, .asc, .lay6, .lay, .mml, .sxm, .otg, .odg, .uop, .std, .sxd, .otp, .odp, .wb2, .slk, .dif, .stc, .sxc, .ots, .ods, .3dm, .max, .3ds, .uot, .stw, .sxw, .ott, .odt, .pem, .p12, .csr, .crt, .key, .pfx, .der

Credit herulume, thanks for extracting this list from the binary.

More details came from https://pastebin.com/xZKU7Ph1 thanks to cyg_x11

# Some other interesting strings 

* BAYEGANSRV\administrator
* Smile465666SA
* wanna18@hotmail.com

Credit: nulldot https://pastebin.com/0LrH05y2

# Encrypted file format

```
typedef struct _wc_file_t {
    char     sig[WC_SIG_LEN]     // 64 bit signature WANACRY!
    uint32_t keylen;             // length of encrypted key
    uint8_t  key[WC_ENCKEY_LEN]; // AES key encrypted with RSA
    uint32_t unknown;            // usually 3 or 4, unknown
    uint64_t datalen;            // length of file before encryption, obtained from GetFileSizeEx
    uint8_t *data;               // Ciphertext Encrypted data using AES-128 in CBC mode
} wc_file_t;
```

Credit for reversing this file format info: cyg_x11.

# Dissecting WannaCry Ransomware

The WannaCrypt ransomware was basically having 3 components that helps in carrying out the attack. Below are the components with their hash values:

* Dropper ‚Äì 24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c
* Encrypter ‚Äì ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa
* Decrypter ‚Äì b9c5d4339809e0ad9a00d4d3dd26fdf44a32819a54abf846bb9b560d81391c25

 ## Static Analysis
 
 Before proceeding with the code analysis I wanted to have a look at the metadata of the file as this gives out a lot of valuable information which can be beneficial in the later analysis. I always prefer to first look at the strings before deeply analyzing any malware sample. Some of the interesting strings that I found during analysis are mentioned below:
 
 ```
    Windows 2000 2195
    Windows 2000 5.0
    \\172.16.99.5\IPC$
    Windows 2000 2195
    Windows 2000 5.0
    Microsoft Base Cryptographic Provider v1.0
    %s -m security
    C:\%s\qeriuwjhrf
    C:\%s\%s
    tasksche.exe
    hxxp://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com
    WanaCrypt0r
    msg/m_greek.wnry
    msg/m_indonesian.wnry
    msg/m_italian.wnry
    msg/m_japanese.wnry
    msg/m_korean.wnry
    msg/m_latvian.wnry
    msg/m_norwegian.wnry
    msg/m_polish.wnry
    msg/m_portuguese.wnry
    mssecsvc.exe
    cmd.exe /c ‚Äú%s‚Äù
    tasksche.exe
    t.wnry
    icacls . /grant Everyone:F /T /C /Q
    attrib +h .
    WNcry@2ol7

```
  
I quickly navigated to my isolated machine FlareVM, and with the help of a tool called PEiD I found out that the dropper is compiled with Microsoft Visual C++ and is having a Windows 32-bit subsystem. So, our sample here is not packed.     

![flarevm](/Ransomware/WannaCry/images/PEiDv0.95.png)


Moving ahead and identifying what interesting information we can get from the headers of our sample file we can use a tool called PEStudio which gave us pretty interesting information about the headers and metadata of sample. There were a couple of interesting things to note though. We can see that the sample is imitating as a legitimate Microsoft Disk Defragmenter file from Microsoft but the actual filename is specified as lhdfrgui.exe.

![pestudio](/Ransomware/WannaCry/images/pestudio.png)
  
Another interesting thing to note is the Resource section of the sample which is marked as executable. Malware authors basically hide their extra executable in the resource section. And this is what we found here in this sample. The name of the resource is 1831 and can be confirmed that it is an executable file by looking at the first-byte-text field column which is MZ in ASCII.

With extra executable embedded in the resource section, we can assume that it will be dropped later during the execution of malware and more evil things will be done to the system.

![firstbyte](/Ransomware/WannaCry/images/firstbyte.png)


 ## Dropper Analysis

When the WannaCry dropper is executed, it first makes an attempt to connect to the domain  http://www[.]iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com and checks whether a domain is registered and successful connection to the domain is made or not. If the connection is successful the malware terminates itself. And if the connection to the domain fails then it proceeds with infecting the targeted system. The dropper does this by checking several arguments being passed to the API calls and if it hits the ZF=0 then it proceeds with the initial infection. The important point to note here is how the malware opens a connection to access the Internet. dwAccessType set to 1 means it should bypass any proxy that is configured to access the Internet. So, any machine which is only allowed to communicate to the internet through a proxy will also affect those systems if it is hit by a WannaCry.


![domain](/Ransomware/WannaCry/images/domain.png)

The malware then checks for 2 arguments ‚Äú-m security‚Äù before proceeding to which step to take further. This is because if the malware is launched for the very first time on an infected machine then it goes ahead with creating a new service called mssecsvc2.0 with the two command-line arguments mentioned above. But if it is started without the mentioned arguments, then it skips the service creation step and goes ahead with propagating to the network by exploiting SMB vulnerability.

![servicecreation](/Ransomware/WannaCry/images/servicecreation.png)

Next, on the way to performing its initial infection, the malware identifies the name of the target machine and opens up a Service Control Manager and creates a service named ‚Äúmssecsvc2.0‚Äù having a display name as ‚ÄúMicrosoft Security Center (2.0) Service‚Äù and finally starts a service.


![servicecreated](/Ransomware/WannaCry/images/servicecreated.png)

The dropper then locates the embedded resource named R1831, which we saw earlier during static analysis, loads it into memory and writes the contents of that resource to a file at "C:\Windows\tasksche.exe" and moves the contents of that file to a new file "C:\Windows\qeriuwjhrf" if it already exists. If it doesn‚Äôt exist then it simply copies the contents to "C:\Windows\qeriuwjhrf".

The file tasksche.exe is basically an encrypter that starts encrypting the files in the backend as soon as it is launched.

![tasksche](/Ransomware/WannaCry/images/tasksche.png)

The newly created file is then dropped to the specified location and is launched by calling CreateProcessA. The file being launched is a console application that will run without any window being seen to the user.



##  Malware Propagation ‚Äì SMB Vuln Exploitation

WannaCry also tries to propagate to the network by actually exploiting the SMB EternalBlue vulnerability. The exploit used is the DoublePulsar which was initially developed by the NSA and was later leaked by a hacking group called Shadow Brokers. We will now take a look at how the WannaCry leverages the vulnerability to exploit it and propagates to the network like a worm.

The WannaCry dropper, if executed without the command line arguments which we saw earlier, that malware was checking, will try to propagate to the network which it does by opening the service ‚Äúmssecsvc2.0‚Äù having the full access permissions, it then changes the service configuration by calling the ```ChangeServiceConfig2A``` function and later calls the ```StartServiceCtrlDispatcherA```  function.


![startservicedispatcher](/Ransomware/WannaCry/images/startservicedispatcher.png)


```StartServiceCtrlDispatcherA```  starts the control dispatcher thread. The dispatcher thread returns whenever there‚Äôs an error and when all the processes have been terminated. Below code registers the Service Control Handler and starts up a thread that contains the exploit payload.


![serivehandler](/Ransomware/WannaCry/images/servicehandler.png)


The malware spreads by setting up a Windows sockets API and uses Windows default Cryptography Service Provider (CSP) ‚ÄúMicrosoft Base Cryptographic Provider 1.0‚Äù to generate a crypto algorithm which is later used to generate random numbers by calling CryptGenRandom function.


![csprovider](/Ransomware/WannaCry/images/csprovider.png)


![cryptgen](/Ransomware/WannaCry/images/cryptgen.png)

Below is the image which initiates the thread containing the payload to transfer to other machines and for this malware calls the GetAdaptersInfo function on the local machine to get the IPs located inside the function named _LAN_config.


![cryptgen](/Ransomware/WannaCry/images/callingpayload.png)

The below code contains a call to the _getAdaptersInfo which contains information about the network adapter on the machine and one of the members IpAddressList provides the list of the IP addresses associated with the particular network adapter. So, the malware after enumerating a network adapter on the system and identifying their respective IP addresses on a network, starts a thread and attempts to connect to the IP on port 445 and attempts to exploit an SMB vulnerability. Kindly, refer to the https://docs.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010 for more info on the vulnerability.



![adapterinfo](/Ransomware/WannaCry/images/getadapterinfo.png)




If connection succeeds, it proceeds by negotiating to get the SMB tree ID.  It then makes 5 attempts to send a packet based on the ETERNALBLUE (MS17-010) exploit.   

The response that it expects from the target is a value of 0x51 found in the response data.


![expectedresponse](/Ransomware/WannaCry/images/expectedresponse.png)


This means that it signals that the exploit was successful and that it can send the payload containing this Wannacrypt malware file using the DOUBLEPULSAR shellcode. The payload is then encrypted using simple byte XOR before it gets into the target computer.



### File Encryption Summary:



- Ransomware Executable Imports its RSA Private Key from .data section to Decrypt a Payload DLL to File t.wry.
- Payload DLL Generates a New RSA Key Pair.
- New RSA Public Key is saved to 00000000.pky.
- New RSA Private Key is encrypted by CryptEncrypt API by using Payload DLL‚Äôs RSA Public Key from its .data section.
- Encrypted RSA Private Key is saved to 00000000.eky.
- Payload DLL Finds the Target Files and generates one AES Key per File.
- Payload DLL uses NEW Public RSA Key from 00000000.pky to Encrypt AES Key of target File and saves Encrypted AES Key to the target File.
- Payload DLL AES Encrypts the target File and writes it to new File with .WCRY Extension.
- To decrypt the files, the WANNACRY Decryptor looks for 00000000.dky file which contains the RSA Private Key from Malware Authors.
- RSA Private Key from Malware Authors can be used to Decrypt AES Key per File, then Decrypt each File using AES Keys.



##  The sinkhole that saved the Internet


- The Achilles heel of malware is the need to call home to its operator. For ransomware, there has to be a mechanism for the program‚Äôs operator to collect the ransom money and unlock the data. These communications can provide a way for law enforcement to track down the cybercriminals, so they often build into their malware something called a kill switch.

- Generally, a kill switch is a mechanism for turning off a device or a piece of software remotely ‚Äì and abruptly ‚Äì in an emergency, such as when it has been stolen or accessed without authorisation. In malware, a kill switch is a way for the operator to terminate their connection to the software to prevent authorities from discovering their identity.
One kill switch method is to redirect the malware‚Äôs communications to a ‚Äúsinkhole‚Äù server, which can render it ineffective. Investigators can study the malware and look for such a kill switch or a way to take over the software. A sophisticated piece of malware will often run its control communication across multiple unregistered internet domains. By periodically changing the domain it uses, the software can thwart attempts to understand or neutralise it. This means investigators need to constantly adapt and register any new domains the malware may try to use to make the sinkhole effective.


- In the case of WannaCry, a researcher using the pseudonym MalwareTech ended up accidentally activating the kill switch when he tried to create a sinkhole in order to study the software. WannaCry included code that looked to check if a specified domain had been registered. If it received a response from the domain, it shut down. If not, it continued to work. So when MalwareTech registered the domain, it effectively activated the kill switch. This kill switch was probably inserted to prevent investigators studying the software in a closed virtual environment called a ‚Äúsandbox‚Äù. These typically respond to all communication attempts by the malware with signals from registered domains. So when WannaCry received a response from the domain, it was tricked into thinking it was in a sandbox and shut down to protect itself.



## Official Statements Issued

- By "White House" <br>
   https://www.whitehouse.gov/briefings-statements/press-briefing-on-the-attribution-of-the-wannacry-malware-attack-to-north-korea-121917/
   
   
- By "NHS" <br>
    https://digital.nhs.uk/news-and-events/news-archive/2017-news-archive/statement-on-reported-nhs-cyber-attack
    - NAO Investigation on NHS pertaining to WannaCry <br>
      https://www.nao.org.uk/wp-content/uploads/2017/10/Investigation-WannaCry-cyber-attack-and-the-NHS.pdf
    
    
- By "CERT-In" - Indian Computer Emergency Response Team <br>
 https://www.cyberswachhtakendra.gov.in/alerts/wannacry_ransomware.html
     
     
     
 ## Adding Up the Cost of WannaCry
 
 Over a year after the initial ransomware attack, WannaCry is still making headlines and causing residual damage. The National Health Service (NHS) has revealed WannaCry costs totaled more than $100 million.

According to estimates from the UK‚Äôs Department of Health and Social Care, the initial damages from the attack were about $25 million, but the bulk of the costs came in the aftermath at around $94 million related to IT support and restoring data and systems.

WannaCry hit thousands of organizations in over 150 countries, demanding a ransom equal to roughly $300 per attack.

However, the vast majority of the financial burden came in the months following the attack, with an estimated ¬£72m spent across June and July 2017 in order to fix the damage and help ensure that systems were more secure in future. 


## Vulnerability disclosure

The specific vulnerability that it uses to propagate is ETERNALBLUE.

This was developed by "equation group" an exploit developer group associated with the NSA and leaked to the public by "the shadow brokers". Microsoft fixed this vulnerability March 14, 2017. They were not 0 days at the time of release.

* https://blogs.technet.microsoft.com/msrc/2017/04/14/protecting-customers-and-evaluating-risk/
* https://technet.microsoft.com/en-us/library/security/ms17-010.aspx
